<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="[原文]从零开始编写自己的JavaScript框架 1. 模块的定义和加载1.1 模块的定义一个框架想要能支撑较大的应用，首先要考虑怎么做模块化，有了内核和模块加载系统，外围的模式就可以一个一个的增加。不同的 JavaScript 框架，实现模块化方式各有不同，我们来选择一种比较优雅的方式做个讲解。 先问个问题：我们做模块系统的目的是什么？如果觉得这个问题难以回答，可以从反面来考虑：假如不做模块系">
<meta property="og:type" content="article">
<meta property="og:title" content="&lt;摘抄&gt;从零开始编写自己的 JavaScript 框架">
<meta property="og:url" content="r0ger1tlearn.com/2016/11/07/a-javascript-framework-from-0-to-1/index.html">
<meta property="og:site_name" content="Echoes Of The Rainbow">
<meta property="og:description" content="[原文]从零开始编写自己的JavaScript框架 1. 模块的定义和加载1.1 模块的定义一个框架想要能支撑较大的应用，首先要考虑怎么做模块化，有了内核和模块加载系统，外围的模式就可以一个一个的增加。不同的 JavaScript 框架，实现模块化方式各有不同，我们来选择一种比较优雅的方式做个讲解。 先问个问题：我们做模块系统的目的是什么？如果觉得这个问题难以回答，可以从反面来考虑：假如不做模块系">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2016-11-07T01:00:00.000Z">
<meta property="article:modified_time" content="2023-06-29T13:27:54.448Z">
<meta property="article:author" content="boyongjiong">
<meta property="article:tag" content="JavaScript">
<meta property="article:tag" content=" React">
<meta property="article:tag" content=" Node.js">
<meta property="article:tag" content=" GraphQL">
<meta name="twitter:card" content="summary">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>&lt;摘抄&gt;从零开始编写自己的 JavaScript 框架</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.1"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/projects_url">Projects</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2017/07/15/http-protocol/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=r0ger1tlearn.com/2016/11/07/a-javascript-framework-from-0-to-1/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=r0ger1tlearn.com/2016/11/07/a-javascript-framework-from-0-to-1/&text=&lt;摘抄&gt;从零开始编写自己的 JavaScript 框架" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=r0ger1tlearn.com/2016/11/07/a-javascript-framework-from-0-to-1/&title=&lt;摘抄&gt;从零开始编写自己的 JavaScript 框架" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=r0ger1tlearn.com/2016/11/07/a-javascript-framework-from-0-to-1/&is_video=false&description=&lt;摘抄&gt;从零开始编写自己的 JavaScript 框架" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=&lt;摘抄&gt;从零开始编写自己的 JavaScript 框架&body=Check out this article: r0ger1tlearn.com/2016/11/07/a-javascript-framework-from-0-to-1/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=r0ger1tlearn.com/2016/11/07/a-javascript-framework-from-0-to-1/&title=&lt;摘抄&gt;从零开始编写自己的 JavaScript 框架" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=r0ger1tlearn.com/2016/11/07/a-javascript-framework-from-0-to-1/&title=&lt;摘抄&gt;从零开始编写自己的 JavaScript 框架" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=r0ger1tlearn.com/2016/11/07/a-javascript-framework-from-0-to-1/&title=&lt;摘抄&gt;从零开始编写自己的 JavaScript 框架" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=r0ger1tlearn.com/2016/11/07/a-javascript-framework-from-0-to-1/&title=&lt;摘抄&gt;从零开始编写自己的 JavaScript 框架" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=r0ger1tlearn.com/2016/11/07/a-javascript-framework-from-0-to-1/&name=&lt;摘抄&gt;从零开始编写自己的 JavaScript 框架&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=r0ger1tlearn.com/2016/11/07/a-javascript-framework-from-0-to-1/&t=&lt;摘抄&gt;从零开始编写自己的 JavaScript 框架" target="_blank" rel="noopener"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-模块的定义和加载"><span class="toc-number">1.</span> <span class="toc-text">1. 模块的定义和加载</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-模块的定义"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 模块的定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-模块的使用"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 模块的使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-模块的加载"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 模块的加载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-小结"><span class="toc-number">1.4.</span> <span class="toc-text">1.4 小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-数据绑定"><span class="toc-number">2.</span> <span class="toc-text">2. 数据绑定</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-数据绑定的原理"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 数据绑定的原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-数据绑定的实现"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 数据绑定的实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-小结"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 小结</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        &lt;摘抄&gt;从零开始编写自己的 JavaScript 框架
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Echoes Of The Rainbow</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2016-11-07T01:00:00.000Z" itemprop="datePublished">2016-11-07</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/%E6%8A%80%E6%9C%AF%E5%90%91/">技术向</a>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><a href="http://www.ituring.com.cn/article/48461" target="_blank" rel="noopener">[原文]从零开始编写自己的JavaScript框架</a></p>
<h2 id="1-模块的定义和加载"><a href="#1-模块的定义和加载" class="headerlink" title="1. 模块的定义和加载"></a>1. 模块的定义和加载</h2><h3 id="1-1-模块的定义"><a href="#1-1-模块的定义" class="headerlink" title="1.1 模块的定义"></a>1.1 模块的定义</h3><p>一个框架想要能支撑较大的应用，首先要考虑怎么做模块化，有了内核和模块加载系统，外围的模式就可以一个一个的增加。不同的 JavaScript 框架，实现模块化方式各有不同，我们来选择一种比较优雅的方式做个讲解。</p>
<p>先问个问题：我们做模块系统的目的是什么？如果觉得这个问题难以回答，可以从反面来考虑：假如不做模块系统，有什么样的坏处？</p>
<p>我们经历过比较粗放、混乱的前端开发阶段，页面里充满了全局变量，全局函数。那时候要复。用 js 文件，就是把某些 js 函数放到一个文件里，然后让多个页面都来引用。</p>
<p>考虑到一个页面可以引用多个这样的 js，这些 js 互相又不知道别人里面写了什么，很容易造成命名的冲突，而产生这种冲突的时候，又没有哪里能够提示出来。所以我们要有一种办法，把作用域比较好的隔开。</p>
<p>JavaScript 这种语言比较奇怪，奇怪在哪里呢？它的现有版本里没有 package 跟 class，要是有，我们也没必要来考虑什么自己做模块化了。那它是要用什么东西来隔绝作用域呢？</p>
<p>在很多传统高级语言里，变量作用域的边界是大括号，在{}里面定义的变量，作用域不会传到外面去，但我们的 JavaScript 大人不是这样的，它的边界是 function。所以我们这段代码，仍然能打印出值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;<span class="number">5</span>; i++) &#123;</span><br><span class="line">  <span class="comment">// do something...</span></span><br><span class="line">&#125;</span><br><span class="line">alert(i);</span><br></pre></td></tr></table></figure>

<p>那么我们只能选用 function 做变量的容器，把每个模块封装到一个 function 里。现在问题又要来了，这个 function 本身的作用域是全局的，怎么办？我们想不到办法，拔剑四顾心茫然。</p>
<p>我们有没有可以参照的东西呢？这时候，脑海中一群语言飘过：C 语言飘过：“我不是面向对象语言哦，不需要想你这么组织哦”，“死开！”，Java 飘过：“我是纯面向对象语言哟，连 main 都要在类中，编译的时候通过装箱清单指定入口哦”，“死开！”，C++ 飘过：“我也是纯面向对象语言哦”，等等，C++是纯面向对象的语言吗？你的 main 是什么？？？ main 是特例，不在任何类中！<br>TIPS：如何利用面向对象编程的 4 个原理（封装、抽象、继承和多态）</p>
<p>啊，我们发现了什么，既然无法避免全局的作用域，那与其让100个 function 都全局，不如只让一个来全局，其他的都由它管理。</p>
<p>本来我们打算自己当上帝的，现在只好改行先当个工商局长。你想开店吗？先来注册，不然封杀你！于是良民们纷纷来注册。店名叫什么，从哪进货，卖什么的，一一登记在案，为了方便下面的讨论，我们连进货的过程都让工商局管理起来。</p>
<p>店名，指的就是这里的模块名，从哪里进货，代表他依赖什么其他模块，卖什么，表示它对外提供一些什么特性。</p>
<p>好了，考虑到我们的这个注册管理机构是个全局作用域，我们还得把它挂在 window 上作为属性，然后再用一个function 隔离出来，要不然，别人也定义一个同名的，就把我们覆盖掉了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">window</span>.thin = &#123;</span><br><span class="line">    define: <span class="function"><span class="keyword">function</span> (<span class="params">name, dependencies, factory</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// register a module</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>在这个 Module 方法内部，应当怎么去实现呢？我们的 Module 应当有一个地方存储，但存储是要在工商局内部的，不是随便什么人都可以看到的，所以这个存储结构也放在工商局同样的作用域里。</p>
<p>用什么结构去存储呢？工商局备案的时候，店名不能跟已有的重复，所以我们发现这是用 map 的很好场景，考虑到 JavaScript 语言层面没有 map，我们弄个 Object 来存。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> moduleMap = &#123;&#125;;</span><br><span class="line">  <span class="built_in">window</span>.thin = &#123;</span><br><span class="line">    define: <span class="function"><span class="keyword">function</span> (<span class="params">name, dependencies, factory</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (!moduleMap[name]) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="built_in">module</span> = &#123;</span><br><span class="line">          name: name,</span><br><span class="line">          dependencies: dependencies,</span><br><span class="line">          factory: factory,</span><br><span class="line">        &#125;;</span><br><span class="line">        moduleMap[name] = <span class="built_in">module</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> moduleMap[name];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>现在，模块的存储结构就搞好了。</p>
<h3 id="1-2-模块的使用"><a href="#1-2-模块的使用" class="headerlink" title="1.2 模块的使用"></a>1.2 模块的使用</h3><p>存的部分搞好了，我们来看看怎么取。现在来了一个商家，卖木器的，他需要从一个卖钉子的那边进货，卖钉子的已经来注册过了，现在要让这个木器厂能买到钉子。现在的问题是，两个商家处于不同的作用域，也就是说，他们互相不可见，那通过什么方式，我们才能让它们产生调用关系呢？</p>
<p>个人解决不了的问题还是得靠政府，有困难要坚决克服，没有困难就制造困难来克服。现在困难有了，该克服了。商家说，我能不能给你我的进货名单，你帮我查一下它们在哪家店，然后告诉我？这么简单的要求当然一口答应下来，但是采用什么方式传递给你呢？这可犯难了。</p>
<p>我们参考 AngularJS 框架，写了一个类似的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">thin.define(<span class="string">"A"</span>, [], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// module A</span></span><br><span class="line">&#125;);</span><br><span class="line">thin.define(<span class="string">"B"</span>, [<span class="string">"A"</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// module B</span></span><br><span class="line">  <span class="keyword">var</span> a = <span class="keyword">new</span> A();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>看这段代码特别在哪里呢？模块 A 的定义，毫无特别之处，主要看模块 B。它在依赖关系里写了一个字符串的 A，然后在工厂方法的形参写了一个真真切切的 A 类型。嗯？这个有些奇怪啊，你的 A 类型要怎么传递过来呢？其实很简单的，因为我们声明了依赖项的数组，所以可以从依赖项，挨个得到对应的的工厂方法，然后创建实例，传进来。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">use: <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> <span class="built_in">module</span> = moduleMap[name];</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">module</span>.entity) &#123;</span><br><span class="line">    <span class="keyword">var</span> args = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="built_in">module</span>.dependencies.length; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (moduleMap[<span class="built_in">module</span>.dependencies[i]].entiry) &#123;</span><br><span class="line">        args.push(moduleMap[<span class="built_in">module</span>.dependencies[i]].entity);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        args.push(<span class="keyword">this</span>.use(<span class="built_in">module</span>.dependencies[i]));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">module</span>.entity = <span class="built_in">module</span>.factory.apply(noop, args);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">module</span>.entity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以看到，这里面递归获取了依赖项，然后当做参数，用这个模块的工厂方法来实例化了一下。这里我们多做了一个判断，如果模块工厂已经执行过，就缓存在 entity 属性上，不需要每次都创建。以此类推，加入一个模块有多个依赖项，也可以用类似的方式写，毫无压力：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">thin.define(<span class="string">"D"</span>, [<span class="string">"A"</span>, <span class="string">"B"</span>, <span class="string">"C"</span>], <span class="function"><span class="keyword">function</span> (<span class="params">A, B, C</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// module D</span></span><br><span class="line">  <span class="keyword">var</span> a = <span class="keyword">new</span> A();</span><br><span class="line">  <span class="keyword">var</span> b = <span class="keyword">new</span> B();</span><br><span class="line">  <span class="keyword">var</span> c = <span class="keyword">new</span> C();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>注意了，D模块的工厂，实参的名称未必就要是跟依赖项一致，比如，以后我们代码较多，可以给依赖项和模块名称加命名空间，可能变成这样：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">thin.define(<span class="string">"foo.D"</span>, [<span class="string">"foo.A"</span>, <span class="string">"foo.B"</span>, <span class="string">"foo.C"</span>], <span class="function"><span class="keyword">function</span> (<span class="params">A, B, C</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// module D</span></span><br><span class="line">  <span class="keyword">var</span> a = <span class="keyword">new</span> A();</span><br><span class="line">  <span class="keyword">var</span> b = <span class="keyword">new</span> B();</span><br><span class="line">  <span class="keyword">var</span> c = <span class="keyword">new</span> C();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这段代码仍然可以正常运行。我们来做另外一个测试，改变形参的顺序：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">thin.define(<span class="string">"A"</span>, [], <span class="function"><span class="keyword">function</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"a"</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">thin.define(<span class="string">"B"</span>, [], <span class="function"><span class="keyword">function</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"b"</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">thin.define(<span class="string">"C"</span>, [], <span class="function"><span class="keyword">function</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"c"</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">thin.define(<span class="string">"D"</span>, [<span class="string">"A"</span>, <span class="string">"B"</span>, <span class="string">"C"</span>], <span class="function"><span class="keyword">function</span> (<span class="params">B, A, C</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> B + A + C;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> D = thin.use(<span class="string">"D"</span>);</span><br><span class="line">alert(D);</span><br></pre></td></tr></table></figure>

<p>试试看，我们的 D 打出什么结果呢？结果是”abc”，所以说，模块工厂的实参只跟依赖项的定义有关，跟形参的顺序无关。我们看到，在 AngularJS 里面，并非如此，实参的顺序是跟形参一致的，这是怎么做到的呢？</p>
<p>我们先离开代码，思考这么一个问题：如何得知函数的形参名数组？对，我们是可以用 func.length 得到形参个数，但无法得到每个形参的变量名，那怎么办呢？</p>
<p>AngularJS 使用了一种比较极端的办法，分析了函数的字面量。众所周知，在 JavaScript 中，任何对象都隐含了 toString 方法，对于一个函数来说，它的 toString 就是自己的实现代码，包含函数签名和注释。下面我贴一下 AngularJS 里面的这部分代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> FN_ARGS = <span class="regexp">/^function\s*[^\(]*\(\s*([^\)]*)\)/m</span>;</span><br><span class="line"><span class="keyword">var</span> FN_ARG_SPLIT = <span class="regexp">/,/</span>;</span><br><span class="line"><span class="keyword">var</span> FN_ARG = <span class="regexp">/^\s*(_?)(\S+?)\1\s*$/</span>;</span><br><span class="line"><span class="keyword">var</span> STRIP_COMMENTS = <span class="regexp">/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/mg</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">annotate</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> $inject,</span><br><span class="line">      fnText,</span><br><span class="line">      argDecl,</span><br><span class="line">      last;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> fn == <span class="string">'function'</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!($inject = fn.$inject)) &#123;</span><br><span class="line">      $inject = [];</span><br><span class="line">      fnText = fn.toString().replace(STRIP_COMMENTS, <span class="string">''</span>);</span><br><span class="line">      argDecl = fnText.match(FN_ARGS);</span><br><span class="line">      forEach(argDecl[<span class="number">1</span>].split(FN_ARG_SPLIT), <span class="function"><span class="keyword">function</span>(<span class="params">arg</span>)</span>&#123;</span><br><span class="line">        arg.replace(FN_ARG, <span class="function"><span class="keyword">function</span>(<span class="params">all, underscore, name</span>)</span>&#123;</span><br><span class="line">          $inject.push(name);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">      fn.$inject = $inject;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isArray(fn)) &#123;</span><br><span class="line">    last = fn.length - <span class="number">1</span>;</span><br><span class="line">    assertArgFn(fn[last], <span class="string">'fn'</span>);</span><br><span class="line">    $inject = fn.slice(<span class="number">0</span>, last);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    assertArgFn(fn, <span class="string">'fn'</span>, <span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> $inject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，这个代码也不长，重点是类型为 function 的那段，首先去除了注释，然后获取了形参列表字符串，这段正则能获取到两个结果，第一个是全函数的实现，第二个才是真正的形参列表，取第二个出来 split，就得到了形参的字符串列表了，然后按照这个顺序再去加载依赖模块，就可以让形参列表不对应于依赖项数组了。</p>
<p>ANgularJS 这段代码很强大，但是要损耗一些性能，考虑到我们的框架首要原则是简单，甚至可以为此牺牲一些灵活性，我们不做这么复杂的事情了。</p>
<h3 id="1-3-模块的加载"><a href="#1-3-模块的加载" class="headerlink" title="1.3 模块的加载"></a>1.3 模块的加载</h3><p>到目前为止，我们可以把多个模块都定义在一个文件中，然后手动引入这个 js 文件，但是如果一个页面要引用很多个模块，引入工作就变得比较麻烦，比如说，单页面应用程序（SPA）一般比较复杂，往往包含数以万计行数的 js 代码，这些代码至少分布在几十个甚至成百上千的模块中，如果我们也在主界面就加载他们，载入时间会非常难以接受。但我们可以这样看：主界面加载的时候，并不是用到了所有这些功能，能否先加载那些必须的，而把剩下的放在需要用的时候再去加载？</p>
<p>所以我们可以考虑万能的 AJAX，从服务端获取一个 js 的内容，然后….，怎么办，你当然说不能 eval 了，因为据说 eval 很 evil 啦，但是它 evil 在哪里呢？主要是破坏全局作用域啦，怎么怎么，但是如果这些文件里面都是按照我们规定的模块格式写，好像也没有什么在全局作用域的…，好吧。</p>
<p>算啦，我们还是用最简单的方式，就是动态创建 script 标签，然后设置 src，添加到 document.head 里面，然后监听它们的完成事件，做后续操作。真的很简单，因为我们的框架不需要考虑那么多种情况，不需要 AMD，不需要 require 那么麻烦，用着框架的人必须按照这里的原则写。</p>
<p>所以，说真的我们这里没那么复杂啦，要是你们想看更详细原理不如去看这个，解释的比我好诶：<br><a href="http://coolshell.cn/articles/9749.html#jtss-tsina" target="_blank" rel="noopener">JavaScript 的装载和执行</a><br>[补一段，@Franky 大神指出了这篇文章中一些不符合现状的地方，我把它也贴在这里，共读者参考]</p>
<blockquote>
<p>很多观点都是，史蒂夫那本老书上的观点，和那时候同期产生的一些数据和资料…所以显得不少东西说的都太想当然了…譬如 script 标签的加载和执行会阻塞后面资源的加载和执行之类的。说的过于肯定了。比如 Chrome 7+ 就开始逐渐改进的——预加载机制，就分 head 里面的资源、body 里面的资源，两个资源是否跨界三种情形，不提这些浏览器，我们看看 ie10 也同样改进了死循环10秒，这后面的图片能被提前加载，就不用说其他 A 级浏览器的丰富的优化策略了。所以还是建议博主，别拿几年前的老资料作为依据，尤其这些数据是用来说明更新速度像在赛跑一样的各个浏览器了。</p>
<p>关于 defer，似乎史蒂夫的老书上是这么说的么？显然没有测试全非 ie 浏览器的各个版本，或者是他测试数据的时候 ff 某大版本的几个 beta 子版本还没出现？</p>
<p>其次是就你的加载器提到的预加载策略，你有测过所有浏览器用 Object 预加载可能涉及到的问题么（比如 chrome8，9的预加载的会话级别的资源类型缓存 bug）。抛开这个问题不谈，假设你预加载到一般，用户再次触发了加载。你觉得这种情况如果频繁发生，是否合适？你的预加载策略连script.onload 状态都无法测知，进一步优化的可能性就消失了。考虑下为什么 seajs 的 umd 要设计成那个样子？</p>
<p>最后吐槽下你的代码，有注意到你用 document.body.appendChild 来向 dom 中插入脚本，我的建议是，永远不要这样做 ，除非你可以无视 ie6用户、以及 ie7缺失某些补丁的子版本。</p>
<p>你可以选择 body，可以但请使用 insertBefore。但在某些极端情况下，这仍然会发生问题，最佳实践是 head.insertBefore 向其第一个子节点插入。（你甚至无需检测是否存在子节点，这个 api 会在没有子节点的时候，行为同 appendChild）。而更加稳妥的情况是：如果注入 script，发现document.head 还没有被构建时，可以自己造一个，这才是一个通用加载器要做到的程度…</p>
</blockquote>
<p>我也偷懒了，只是贴一下代码，顺便解释一下，界面把所依赖的 js 文件路径放在数组里，然后挨个创建 script 标签，src 设置为路径，添加到 head 中，监听他们的完成事件。在这个完成时间里，我们要做这么一些事情：在 fileMap 记录当前 js 文件的路径，防止以后重复加载，检查列表中所有文件，看看是否全部加载完了，如果全加载好了，就执行回调。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>: <span class="function"><span class="keyword">function</span> (<span class="params">pathArr, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; pathArr.length; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> path = pathArr[i];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!fileMap[path]) &#123;</span><br><span class="line">      <span class="keyword">var</span> head = <span class="built_in">document</span>.getElementsByTagName(<span class="string">'head'</span>)[<span class="number">0</span>];</span><br><span class="line">      <span class="keyword">var</span> node = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</span><br><span class="line">      node.type = <span class="string">'text/javascript'</span>;</span><br><span class="line">      node.async = <span class="string">'true'</span>;</span><br><span class="line">      node.src = path + <span class="string">'.js'</span>;</span><br><span class="line">      node.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        fileMap[path] = <span class="literal">true</span>;</span><br><span class="line">        head.removeChild(node);</span><br><span class="line">        checkAllFiles();</span><br><span class="line">      &#125;;</span><br><span class="line">      head.appendChild(node);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">checkAllFiles</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> allLoaded = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; pathArr.length; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!fileMap[pathArr[i]]) &#123;</span><br><span class="line">        allLoaded = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (allLoaded) &#123;</span><br><span class="line">      callback();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-4-小结"><a href="#1-4-小结" class="headerlink" title="1.4 小结"></a>1.4 小结</h3><p>到此为止，我们的建议框架的模块定义系统就完成了。完整的代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> moduleMap = &#123;&#125;;</span><br><span class="line">  <span class="keyword">var</span> fileMap = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> noop = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> thin = &#123;</span><br><span class="line">    define: <span class="function"><span class="keyword">function</span> (<span class="params">name, dependencies, factory</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (!moduleMap[name]) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="built_in">module</span> = &#123;</span><br><span class="line">          name: name,</span><br><span class="line">          dependencies: dependencies,</span><br><span class="line">          factory: factory,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        moduleMap[name] = <span class="built_in">module</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> moduleMap[name];</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    use: <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> <span class="built_in">module</span> = moduleMap[name];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">module</span>.entity) &#123;</span><br><span class="line">        <span class="keyword">var</span> args = [];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="built_in">module</span>.dependencies.length; i++) &#123;</span><br><span class="line">          <span class="keyword">if</span> (moduleMap[<span class="built_in">module</span>.dependencies[i]].entity) &#123;</span><br><span class="line">            args.push(moduleMap[<span class="built_in">module</span>.dependencies[i]].entity);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            args.push(<span class="keyword">this</span>.use(<span class="built_in">module</span>.dependencies[i]));</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">module</span>.entity = <span class="built_in">module</span>.factory.apply(noop, args);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">module</span>.entity;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="built_in">require</span>: <span class="function"><span class="keyword">function</span> (<span class="params">pathArr, callback</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; pathArr.length; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> path = pathArr[i];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!fileMap[path]) &#123;</span><br><span class="line">          <span class="keyword">var</span> head = <span class="built_in">document</span>.getElementsByTagName(<span class="string">'head'</span>)[<span class="number">0</span>];</span><br><span class="line">          <span class="keyword">var</span> node = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</span><br><span class="line">          node.type = <span class="string">'text/javascript'</span>;</span><br><span class="line">          node.async = <span class="string">'true'</span>;</span><br><span class="line">          node.src = path + <span class="string">'.js'</span>;</span><br><span class="line">          node.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            fileMap[path] = <span class="literal">true</span>;</span><br><span class="line">            head.removeChild(node);</span><br><span class="line">            checkAllFiles();</span><br><span class="line">          &#125;;</span><br><span class="line">          head.appendChild(node);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">checkAllFiles</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> allLoaded = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; pathArr.length; i++) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!fileMap[pathArr[i]]) &#123;</span><br><span class="line">            allLoaded = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (allLoaded) &#123;</span><br><span class="line">          callback();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">window</span>.thin = thin;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>测试代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">thin.define(<span class="string">'constant.PI'</span>, [], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">3.1415926</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">thin.define(<span class="string">'shape.Circle'</span>, [<span class="string">'constant.PI'</span>], <span class="function"><span class="keyword">function</span> (<span class="params">pi</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> Circle = <span class="function"><span class="keyword">function</span> (<span class="params">r</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.r = r;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  Circle.prototype = &#123;</span><br><span class="line">    area: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> pi * <span class="keyword">this</span>.r * <span class="keyword">this</span>.r;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Circle;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">thin.define(<span class="string">'shape.Rectangle'</span>, [], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> Rectangle = <span class="function"><span class="keyword">function</span> (<span class="params">l, w</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.l = l;</span><br><span class="line">    <span class="keyword">this</span>.w = w;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  Rectangle.prototype = &#123;</span><br><span class="line">    area: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.l * <span class="keyword">this</span>.w;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Rectangle;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">thin.define(<span class="string">'ShapeTypes'</span>, [<span class="string">'shape.Circle'</span>, <span class="string">'shape.Rectangle'</span>], <span class="function"><span class="keyword">function</span> (<span class="params">Circle, Rectangle</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    CIRCLE: Circle,</span><br><span class="line">    RECTANGLE: Rectangle,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">thin.define(<span class="string">'ShapeFactory'</span>, [<span class="string">'ShapeTypes'</span>], <span class="function"><span class="keyword">function</span> (<span class="params">ShapeTypes</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    getShape: <span class="function"><span class="keyword">function</span> (<span class="params">type</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> shape;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">        <span class="keyword">case</span> CIRCLE:</span><br><span class="line">          shape = <span class="keyword">new</span> ShapeTypes[type](<span class="built_in">arguments</span>[<span class="number">1</span>]);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          shape = <span class="keyword">new</span> ShapeTypes[type](<span class="built_in">arguments</span>[<span class="number">1</span>], <span class="built_in">arguments</span>[<span class="number">2</span>]);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> shape;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ShapeFactory = thin.use(<span class="string">'ShapeFactory'</span>);</span><br><span class="line">alert(ShapeFactory.getShape(<span class="string">'CIRCLE'</span>, <span class="number">5</span>).area());</span><br><span class="line">alert(ShapeFactory.getShape(<span class="string">'RECTANGLE'</span>, <span class="number">3</span>, <span class="number">4</span>).area());</span><br></pre></td></tr></table></figure>
<p>在这个例子中，定义了四个模块，每个模块只需要定义自己所直接依赖的模块，其他的可以不必定义。也可以来这里看测试链接：<a href="http://xufei.github.io/thin/demo/demo.0.1.html" target="_blank" rel="noopener">测试用例</a></p>
<h2 id="2-数据绑定"><a href="#2-数据绑定" class="headerlink" title="2. 数据绑定"></a>2. 数据绑定</h2><h3 id="2-1-数据绑定的原理"><a href="#2-1-数据绑定的原理" class="headerlink" title="2.1 数据绑定的原理"></a>2.1 数据绑定的原理</h3><p>数据绑定是一种很便捷的特性，一些RIA框架带有双向绑定功能，比如Flex和Silverlight, 当某个数据发生变更时，所绑定的界面元素也发生变更；当界面元素发生变化时，数据也跟着变化，这种功能在处理表单数据的填充和收集时，是非常有用的。</p>
<p>在HTML中，原生是没有这样的功能的，但有些框架做到了，它们是怎么做到的呢？我们来做个简单的demo，顺便探讨一下其中原理</p>
<p>先看数据到界面上的绑定：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;input vm-value=<span class="string">"name"</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">  name: <span class="string">"Tom"</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>如果我们直接给name重新赋值，person.name = “jerry”，怎样才能让界面得到变更？</p>
<p>从直觉来说，我们需要在name发生改变时，触发一个事件，或者调用某个指定的方法，然后才好着手做后面的事情，比如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">  name: <span class="string">"Tom"</span>,</span><br><span class="line">  setName: <span class="function"><span class="keyword">function</span>(<span class="params">newName</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.name = newName;</span><br><span class="line">    <span class="comment">//do something</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这样我们可以在setName里面去给input赋值。推而广之，为了使得实体包含的多个属性都可以运作，可以这么做：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">  name: <span class="string">"Tom"</span>,</span><br><span class="line">  gender: m,</span><br><span class="line">  <span class="keyword">set</span>: function (key, value) &#123;</span><br><span class="line">    <span class="keyword">this</span>[key] = value;</span><br><span class="line">    <span class="comment">//do something</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者合并两个方法，只判断是否传了参数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Person.prototype.name = <span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">arguments</span>.length === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._name;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>._name = value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这种情况下，赋值的时候就是Person.name(“Tom”)， 取值的时候就是var name = Person.name() 了。</p>
<p>有一些框架是通过这种方式来变通实现数据绑定的，对数据的写入只能通过方法调用。但这种方式很不直接，我们来想点别的。</p>
<p>在C#等一些语言中，有一种东西叫存取器，比如说：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">class Person</span><br><span class="line">&#123;</span><br><span class="line">  private string name;</span><br><span class="line"></span><br><span class="line">  public string Name</span><br><span class="line">  &#123;</span><br><span class="line">    get</span><br><span class="line">    &#123;</span><br><span class="line">      return name;</span><br><span class="line">    &#125;</span><br><span class="line">    set</span><br><span class="line">    &#123;</span><br><span class="line">      name &#x3D; value;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用的时候，Person.Name = “Jerry”, 就会调用到set里，相当于是个方法。</p>
<p>这一点非常好，很符合我们的需要，那JavaScript里面有没有类似存取器的特性呢？老早以前是没有的，但现在有了，那就是Object.defineProperty, 它的第三个参数就是可选的存取函数。比如说：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add an accessor property to the object.</span></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(person, <span class="string">"name"</span>, &#123;</span><br><span class="line">  <span class="keyword">set</span>: function (value) &#123;</span><br><span class="line">    <span class="keyword">this</span>._name = value;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="keyword">get</span>: function () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._name;</span><br><span class="line">  &#125;,</span><br><span class="line">  enumerable: <span class="literal">true</span>,</span><br><span class="line">  configurable: <span class="literal">true</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>赋值的时候，person.name = “Tom”, 取值的时候，var name = person.name,简直太美妙了。注意这里define的时候，是定义在实例上的，如果想要定义在类型里面，可以在构造器里面定义。</p>
<p>现在我们从数据到DOM的绑定可以解决掉了，至少我们能够在变量被变更的时候去做一些自己的事情，比如查找这个属性被绑定到那些空间了，然后挨个对其赋值。框架怎么知道属性被绑定到哪些控件了呢？这个直接在第二部分的实现过程中讨论。</p>
<p>再看控件到数据的绑定，这个其实很好理解。无非就是给控件添加change之类的事件监听，在这里，我们在原理方面已经没有什么问题了，现在开始准备把它写出来。</p>
<h3 id="2-2-数据绑定的实现"><a href="#2-2-数据绑定的实现" class="headerlink" title="2.2 数据绑定的实现"></a>2.2 数据绑定的实现</h3><p>我们的框架在启动之前，要先把前面所说的这种绑定关系收集起来，这种属性会分布于DOM的各个角落，一个很现实的做法是，递归遍历界面的每个DOM节点，检测该属性，于是我们的代码结构大致如下所示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseElement</span>(<span class="params">element</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>, l=element.attributes.length; i&lt;l; i++) &#123;</span><br><span class="line">    parseAttribute(element.attributes[i]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>, l=element.children.length; i&lt;l; i++) &#123;</span><br><span class="line">    parseElement(element.children[i]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是我们这时候面临一个问题，比如说你的输入框绑定在name变量上，这个name应该从属于什么？它是全局变量吗？</p>
<p>我们在开始做这个框架的时候强调了一个原则：业务模块不允许定义全局变量，框架内部也尽量少有全局作用域，到目前为止，我们只暴露了thin一个全局变量，所以这里不能破坏这个原则。</p>
<p>因此，我们要求业务开发人员去定义一个视图模型，把变量包装起来，所包装的不限于变量，也可以有方法。比如下面，我们定义了一个实体叫Person，带两个变量，两个方法，然后我们演示一下怎么把它们绑定到HTML界面。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">thin.define(&quot;Person&quot;, [], function () &#123;</span><br><span class="line">  function Person() &#123;</span><br><span class="line">    this.name &#x3D; &quot;Tom&quot;;</span><br><span class="line">    this.age &#x3D; 5;</span><br><span class="line">  &#125;</span><br><span class="line">  Person.prototype &#x3D; &#123;</span><br><span class="line">    growUp: function () &#123;</span><br><span class="line">      this.age++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  return Person</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>模型方面都准备好了，先在来看界面：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;div vm-model&#x3D;&quot;Person&quot;&gt;</span><br><span class="line">  &lt;input type&#x3D;&quot;text&quot; vm-value&#x3D;&quot;name&quot;&#x2F;&gt;</span><br><span class="line">  &lt;input type&#x3D;&quot;text&quot; vm-value&#x3D;&quot;age&quot;&#x2F;&gt;</span><br><span class="line">  &lt;input type&#x3D;&quot;button&quot; vm-click&#x3D;&quot;growUp&quot; value&#x3D;&quot;Grow Up&quot;&#x2F;&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br></pre></td></tr></table></figure>

<p>为了使得结构更加容易看，我们把界面的无关属性比如样式之类都去掉，只留下不能再减少的这么一段。先在我们可以看到，在界面的顶层定义一个vm-model属性，值为实体的名称。两个输入框通过vm-value来绑定到实例属性，vm-init绑定界面的初始方法，vm-click绑定按钮的点击事件。</p>
<p>好了，现在我们可以来扫描这个简单的DOM 结构了。想要做这么一个绑定，首先要考虑数据从哪里来？在绑定name和age属性之前，毫无疑问，应当先实例化一个Person，我们怎样才能知道需要把Person模块实例化呢？</p>
<p>当扫描到一个DOM元素的时候，我们要先检测它的vm-model属性，如果有值，就取这个值来实例化，然后，把这个值一直传递下去，在扫描其他属性或者下属DOM元素的时候带进去。这么一来，parseElement就变成一个递归了，于是，它只好有两个参数，变成了这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">function parseElement (element, vm) &#123;</span><br><span class="line">  var model &#x3D; vm;</span><br><span class="line"></span><br><span class="line">  if (element.getAttribute(&quot;vm-model&quot;)) &#123;</span><br><span class="line">    model &#x3D; bindModel(element.getAttribute(&quot;vm-model&quot;));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  for (var i &#x3D; 0, l &#x3D; element.attributes.length; i &lt; l; i++) &#123;</span><br><span class="line">    parseAttribute(element, element.attributes[i], model);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  for (var i &#x3D; 0, l &#x3D; element.children.length;; i &lt; l; i++) &#123;</span><br><span class="line">    parseElement(element.children[i], model);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看看我们打算怎么来实例化这个模型，这个bindModel方法的参数是模块名，于是我们先去use一下，从工厂里生成出来，然后new一下，先这么return出去吧。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function bindModel(modelName) &#123;</span><br><span class="line">  thin.log(&quot;model&quot; + modelName);</span><br><span class="line"></span><br><span class="line">  var model &#x3D; thin.use(modelName, true);</span><br><span class="line">  var instance &#x3D; new model();</span><br><span class="line"></span><br><span class="line">  return instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在我们开始关注parseAttribute函数，可能的attribute有哪些种类呢？我列举了一些很常用的:</p>
<ul>
<li>init,  用于绑定初始化方法</li>
<li>click,  用于绑定点击</li>
<li>value,  绑定变量</li>
<li>enable 和 disable，绑定可用状态</li>
<li>visible 和 invisible，绑定可见状态</li>
</ul>
<p>然后就可以实现我们parseAttribute函数了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">function parseAttribute(element, attr, model) &#123;</span><br><span class="line">  if (attr.name.indexOf(&quot;vm-&quot;) &#x3D;&#x3D;&#x3D; 0) &#123;</span><br><span class="line">    var type &#x3D; attr.name.slice(3);</span><br><span class="line"></span><br><span class="line">    switch (type) &#123;</span><br><span class="line">      case &quot;init&quot;:</span><br><span class="line">        bindInit(element, attr.value, model);</span><br><span class="line">        break;</span><br><span class="line">      case &quot;value&quot;:</span><br><span class="line">        bindValue(element, attr.value, model);</span><br><span class="line">      case &quot;click&quot;:</span><br><span class="line">        bindClick(element, attr.value, model);</span><br><span class="line">        break;</span><br><span class="line">      case &quot;enable&quot;:</span><br><span class="line">        bindEnable(element, attr.value, model, true);</span><br><span class="line">        break;</span><br><span class="line">      case &quot;disable&quot;:</span><br><span class="line">        bindEnable(element, attr.value, model, false);</span><br><span class="line">        break;</span><br><span class="line">      case &quot;visible&quot;:</span><br><span class="line">        bindVisible(element, attr.value, model, true);</span><br><span class="line">        break;</span><br><span class="line">      case &quot;invisible&quot;:</span><br><span class="line">        bindVisible(element, attr.value, model, false);</span><br><span class="line">        break;</span><br><span class="line">      case &quot;element&quot;:</span><br><span class="line">        model[attr.value] &#x3D; element;</span><br><span class="line">        break;</span><br><span class="line">      default:</span><br><span class="line">        &#x2F;&#x2F; statements_def</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意到最后面还有个element类型，本来可以不要这个，但我们考虑到将来，一切都是组件化的时候，界面上打算不写id，也不依靠选择器，而是用某个标志来定位元素，所以就加上了这个，文章最后的示例中使用了它。</p>
<p>这么多绑定，不打算都讲，用bindValue函数来说明一下吧：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindValue</span>(<span class="params">element, key, vm</span>) </span>&#123;</span><br><span class="line">  thin.log(<span class="string">"binding value: "</span> + key);</span><br><span class="line"></span><br><span class="line">  vm.$watch(key, <span class="function"><span class="keyword">function</span> (<span class="params">value, oldValue</span>) </span>&#123;</span><br><span class="line">    element.value = value || <span class="string">""</span>;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  element.onkeyup = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    vm[key] = element.value;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  element.onpaste = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    vm[key] = element.value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们假定每个模型实例上带有一个$watch方法，用于监控某流量的变化，可以传入一个监听函数，当变量变化的时候，自动调用这个函数，并且把新旧两个值传回来。</p>
<p>在这个代码里，我们使用$watch方法给传入的key添加一个监听，监听器里面给监听元素赋值。我们这里偷懒了一下，假定所有的绑定元素都是输入框，所以直接给element.value设置值，为了防止值为空导致显示undefined，把值跟空字符串用短路表达式做了个转换。</p>
<p>接下来，也对element的几个可能导致值变化的事件进行了监听，在里面把模型上对应的值更新掉。这样双向绑定就做好了。</p>
<p>然后回头来看$watch的实现。很显然这里也要一个Map，我们给它取名为$watchers， 存放属性的绑定关系，它的值需要保存一份，供getter获取，同时还有一个数组，存放了该属性绑定的处理函数。当属性发生变更的时候，去挨个把他们调用一下。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Binder = &#123;</span><br><span class="line">  $watch: <span class="function"><span class="keyword">function</span> (<span class="params">key, watcher</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.$watchers[key]) &#123;</span><br><span class="line">      <span class="keyword">this</span>.$watchers[key] = &#123;</span><br><span class="line">        value: <span class="keyword">this</span>[key],</span><br><span class="line">        list: []</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>, key, &#123;</span><br><span class="line">        <span class="keyword">set</span>: function (val) &#123;</span><br><span class="line">          <span class="keyword">var</span> oldValue = <span class="keyword">this</span>.$watchers[key].value;</span><br><span class="line">          <span class="keyword">this</span>.$watchers[key].value = val;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.$watchers[key].list.length; i++) &#123;</span><br><span class="line">            <span class="keyword">this</span>.$watchers[key].list[i](val, oldValue);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        <span class="keyword">get</span>: function () &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">this</span>.$watchers[key].value;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.$watchers[key].list.push(watcher);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是vm怎么就有$watch呢，每个地方都去判断一下非空然后再去创建其实挺麻烦的，所以，这个属性我们可以直接在实例化模型的时候创建出来。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindModel</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  thin.log(<span class="string">"binding model: "</span> + name);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> model = thin.use(name, <span class="literal">true</span>);</span><br><span class="line">  <span class="keyword">var</span> instance = <span class="keyword">new</span> model().extend(Binder);</span><br><span class="line">  instance.$watchers = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看看这里的写法，为什么$watchers要额外设置，而$watch就可以放在Binder里面来extend呢？</p>
<p>先解释extend干了什么，它做的是一个对象的浅拷贝，也就是说，把Binder的属性和方法都复制给了创建出来的model实例，注意，这个所谓的复制，如果是简单类型，那确实复制了，如果是引用类型，那复制的其实只是一个引用，所以如果$watchers也放在Binder里，不同的instance就共享一个$watchers，逻辑就是错误的。那为什么$watch又可以放在这里复制呢？因为它是函数，它的this始终指向当前的执行主体，也就是说，如果放在instance1上执行，指向的就是instance1，放在instance2上执行，指向的就是instance2，我们利用这一点，就可以不用让每个实例都创建一份$watch方法，而是共用同一个。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;Simple binding demo&lt;&#x2F;title&gt;</span><br><span class="line">    &lt;meta charset&#x3D;&quot;utf-8&quot;&gt;</span><br><span class="line">    &lt;meta name&#x3D;&quot;viewport&quot; content&#x3D;&quot;width&#x3D;device-width, initial-scale&#x3D;1.0&quot;&gt;</span><br><span class="line">    &lt;meta name&#x3D;&quot;description&quot; content&#x3D;&quot;binding&quot;&gt;</span><br><span class="line">    &lt;meta name&#x3D;&quot;author&quot; content&#x3D;&quot;xu.fei@outlook.com&quot;&gt;</span><br><span class="line">    &lt;script type&#x3D;&quot;text&#x2F;javascript&quot; src&#x3D;&quot;..&#x2F;js&#x2F;thin.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div vm-model&#x3D;&quot;test.Person&quot;&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;text&quot; vm-value&#x3D;&quot;name&quot;&#x2F;&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;text&quot; vm-value&#x3D;&quot;age&quot;&#x2F;&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;text&quot; vm-value&#x3D;&quot;age&quot;&#x2F;&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;button&quot; vm-click&#x3D;&quot;growUp&quot; value&#x3D;&quot;Grow Up&quot;&#x2F;&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;div vm-model&#x3D;&quot;test.Person&quot; vm-init&#x3D;&quot;init&quot;&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;text&quot; vm-value&#x3D;&quot;name&quot;&#x2F;&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;text&quot; vm-value&#x3D;&quot;age&quot;&#x2F;&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;button&quot; vm-click&#x3D;&quot;growUp&quot; value&#x3D;&quot;Grow Up&quot;&#x2F;&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line">&lt;script type&#x3D;&quot;text&#x2F;javascript&quot;&gt;</span><br><span class="line">    thin.define(&quot;test.Person&quot;, [], function () &#123;</span><br><span class="line">        function Person() &#123;</span><br><span class="line">            this.name &#x3D; &quot;Tom&quot;;</span><br><span class="line">            this.age &#x3D; 5;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Person.prototype &#x3D; &#123;</span><br><span class="line">            init: function () &#123;</span><br><span class="line">                this.name &#x3D; &quot;Jerry&quot;;</span><br><span class="line">                this.age &#x3D; 3;</span><br><span class="line">            &#125;,</span><br><span class="line"></span><br><span class="line">            growUp: function () &#123;</span><br><span class="line">                this.age++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        return Person;</span><br><span class="line">    &#125;);</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>或者访问这里：<a href="http://xufei.github.io/thin/demo/simple-binding.html" target="_blank" rel="noopener">从零开始编写自己的 JavaScript 框架）—— Demo</a><br>以刚才文章提到的内容，还不能完全解释这个例子的效果，因为没看到在哪里调用 parseElement 的。说来也简单，就在 thin.js 里面，直接写了一个 thin.ready，在那边调用了这个函数，去解析了 document.body，于是测试页面里面才可以只写绑定和视图模型。</p>
<p>我们还有一个更实际一点的例子，结合了另外一个系列里面写的简单 DataGrid 控件，做了一个很基础的人员管理界面：<a href="http://xufei.github.io/thin/demo/binding.html" target="_blank" rel="noopener">http://xufei.github.io/thin/demo/binding.html</a></p>
<h3 id="2-3-小结"><a href="#2-3-小结" class="headerlink" title="2.3 小结"></a>2.3 小结</h3><p>到此为止，我们的绑定框架勉强能够运行起来了！虽然简陋，而且要比较新的浏览器才能跑，但是毕竟跑起来了。</p>
<p>注意：Object.defineProperty 仅在 Chrome 等浏览器中可用，IE 需要9以上才比较正常。在司徒正美的 avalon 框架中，巧妙使用 VBScript 绕过这一限制，利用 vbs 的 property 和两种语言的互通，实现了低版本IE的兼容，我们这个框架的目标不是兼容，而是为了说明原理，所以感兴趣的朋友可以去看看 avalon 的源码。</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/projects_url">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-模块的定义和加载"><span class="toc-number">1.</span> <span class="toc-text">1. 模块的定义和加载</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-模块的定义"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 模块的定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-模块的使用"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 模块的使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-模块的加载"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 模块的加载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-小结"><span class="toc-number">1.4.</span> <span class="toc-text">1.4 小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-数据绑定"><span class="toc-number">2.</span> <span class="toc-text">2. 数据绑定</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-数据绑定的原理"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 数据绑定的原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-数据绑定的实现"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 数据绑定的实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-小结"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 小结</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=r0ger1tlearn.com/2016/11/07/a-javascript-framework-from-0-to-1/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=r0ger1tlearn.com/2016/11/07/a-javascript-framework-from-0-to-1/&text=&lt;摘抄&gt;从零开始编写自己的 JavaScript 框架" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=r0ger1tlearn.com/2016/11/07/a-javascript-framework-from-0-to-1/&title=&lt;摘抄&gt;从零开始编写自己的 JavaScript 框架" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=r0ger1tlearn.com/2016/11/07/a-javascript-framework-from-0-to-1/&is_video=false&description=&lt;摘抄&gt;从零开始编写自己的 JavaScript 框架" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=&lt;摘抄&gt;从零开始编写自己的 JavaScript 框架&body=Check out this article: r0ger1tlearn.com/2016/11/07/a-javascript-framework-from-0-to-1/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=r0ger1tlearn.com/2016/11/07/a-javascript-framework-from-0-to-1/&title=&lt;摘抄&gt;从零开始编写自己的 JavaScript 框架" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=r0ger1tlearn.com/2016/11/07/a-javascript-framework-from-0-to-1/&title=&lt;摘抄&gt;从零开始编写自己的 JavaScript 框架" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=r0ger1tlearn.com/2016/11/07/a-javascript-framework-from-0-to-1/&title=&lt;摘抄&gt;从零开始编写自己的 JavaScript 框架" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=r0ger1tlearn.com/2016/11/07/a-javascript-framework-from-0-to-1/&title=&lt;摘抄&gt;从零开始编写自己的 JavaScript 框架" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=r0ger1tlearn.com/2016/11/07/a-javascript-framework-from-0-to-1/&name=&lt;摘抄&gt;从零开始编写自己的 JavaScript 框架&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=r0ger1tlearn.com/2016/11/07/a-javascript-framework-from-0-to-1/&t=&lt;摘抄&gt;从零开始编写自己的 JavaScript 框架" target="_blank" rel="noopener"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2023
    boyongjiong
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/projects_url">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
